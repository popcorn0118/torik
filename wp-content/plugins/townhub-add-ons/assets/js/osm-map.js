!function(u){"use strict";function e(){var e=[];return u("#listing-items .listing-item").length&&u("#listing-items .listing-item").each(function(){var t=decodeURIComponent(u(this).data("lmap"));try{e.push(JSON.parse(t))}catch(t){console.log(t)}}),e}function r(t,e,o){return!isNaN(e)&&t<=e&&e<=o}var o={target:"",center:[parseFloat(_townhub_add_ons.center_lng),parseFloat(_townhub_add_ons.center_lat)],zoom:parseInt(_townhub_add_ons.map_zoom),maxZoom:19,map:null,popup:null,olPopup:null,view:null,features:[],vectorSource:null,clusterSource:null,vectorLayer:null,layerRoute:null,extent:null,multiLineString:null,info_tmpl:_.template(u("#tmpl-map-info").length?u("#tmpl-map-info").html():"",{variable:"data",evaluate:/<#([\s\S]+?)#>/g,interpolate:/{{{([\s\S]+?)}}}/g,escape:/{{([^}]+?)}}(?!})/g}),styleCache:{},init:function(t,e){this.target=t,this.initLayerRoute(),this.initPopup(),this.initView(),this.initVectorSource(e),this.initCluster(),this.initVectorLayer(),this.initMap(),this.fitMap(),this.mapInteraction()},initMap:function(){var t={overlays:[this.popup],target:this.target,view:this.view,layers:[new ol.layer.Tile({preload:3,source:new ol.source.OSM}),this.layerRoute,this.vectorLayer],loadTilesWhileAnimating:!0,interactions:ol.interaction.defaults({mouseWheelZoom:!1})};this.map=new ol.Map(t),window.listingsOSMMap=this.map;var e=new CustomEvent("listingsOSMMapInit",{detail:"mapInit"});window.dispatchEvent(e)},fitMap:function(){this.map.getView().fit(this.extent,{size:this.map.getSize(),duration:1e3}),window.dispatchEvent(new CustomEvent("listingsOSMMapLoaded",{detail:"hasListing"}))},toDefaultMap:function(){this.map.getView().animate({zoom:this.zoom,center:ol.proj.fromLonLat(this.center),duration:1e3}),window.dispatchEvent(new CustomEvent("listingsOSMMapLoaded",{detail:"noListing"}))},initView:function(){this.view=new ol.View({center:ol.proj.fromLonLat(this.center),zoom:this.zoom,maxZoom:this.maxZoom})},initPopup:function(){this.olPopup=document.getElementById("ol-popup"),this.popup=new ol.Overlay({element:this.olPopup,autoPan:!0,autoPanAnimation:{duration:250}})},initLayerRoute:function(){this.multiLineString=new ol.geom.MultiLineString([]),this.layerRoute=new ol.layer.Vector({source:new ol.source.Vector({features:[new ol.Feature({geometry:this.multiLineString})]}),style:[new ol.style.Style({stroke:new ol.style.Stroke({width:3,color:[51,51,51,1]}),zIndex:2})],updateWhileAnimating:!0})},initVectorSource:function(t){if(!t.length)return this.vectorSource=new ol.source.Vector({}),!(this.features=[]);this.vectorSource=new ol.source.Vector({}),this.extent=ol.extent.createEmpty();for(var e=0;e<t.length;e++)if(i=t[e].latitude,a=t[e].longitude,i=parseFloat(i),a=parseFloat(a),r(-90,i,90)&&r(-180,a,180)){var o=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([parseFloat(t[e].longitude),parseFloat(t[e].latitude)],"EPSG:4326","EPSG:3857")),name:t[e].title});o.set("popupInfo",this.locationData(t[e]));var n=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",crossOrigin:"anonymous",src:t[e].gmap_marker?t[e].gmap_marker:_townhub_add_ons.marker})});o.setStyle(n),o.setId(t[e].ID),this.features.push(o),this.vectorSource.addFeature(o),ol.extent.extend(this.extent,o.getGeometry().getExtent())}var i,a;return!0},initCluster:function(){this.clusterSource=new ol.source.Cluster({source:this.vectorSource})},initVectorLayer:function(){var i=this;i.vectorLayer=new ol.layer.Vector({source:i.clusterSource,updateWhileAnimating:!0,updateWhileInteracting:!0,style:function(t){var e=t.get("features");if(null!=e){var o=e.length;if(1<o){var n=i.styleCache[o];return n||(n=new ol.style.Style({image:new ol.style.Circle({radius:20,stroke:new ol.style.Stroke({color:"#fff",width:3}),fill:new ol.style.Fill({color:""!=_townhub_add_ons.td_color?_townhub_add_ons.td_color:"#4db7fe"})}),text:new ol.style.Text({text:o.toString(),fill:new ol.style.Fill({color:"#fff"}),font:"13px 'Quicksand', sans-serif"})}),i.styleCache[o]=n),n}return e[0].getStyle()}}})},locationData:function(t){return this.info_tmpl(t)},mapInteraction:function(){var r=this,t=new ol.interaction.Select({condition:function(n){if(!ol.events.condition.singleClick(n))return!1;var i=[],a=[];if(r.map.forEachFeatureAtPixel(n.pixel,function(t,e){if(null!=(a=t.get("features")))for(var o=0;o<a.length;o++)i.push(a[o])}),1<i.length){if(r.map.getView().getZoom()<r.maxZoom){var o=ol.extent.createEmpty();a.forEach(function(t,e){ol.extent.extend(o,t.getGeometry().getExtent())}),r.map.getView().fit(o,r.map.getSize())}else r.map.forEachFeatureAtPixel(n.pixel,function(t,e){var o=t.get("features");r.displayOverlapping(o,n.pixel)});return!1}if(1!==i.length)return r.popup.setPosition(void 0),!1;var t=i[0];r.olPopup.innerHTML=t.get("popupInfo"),r.popup.setPosition(n.coordinate);var e=new CustomEvent("mapPopupOpened",{detail:"osm"});return window.dispatchEvent(e),!1}});r.map.addInteraction(t)},displayOverlapping:function(t,e){if(null!=t){var n=this,o=t[0];if(o){var i=o.getGeometry().getCoordinates(),a=n.map.getPixelFromCoordinate(i),r=n.generatePointsCircle(t.length,a);n.multiLineString.setCoordinates([]),t.forEach(function(t,e){var o=n.map.getCoordinateFromPixel(r[e]);n.multiLineString.appendLineString(new ol.geom.LineString([i,o])),t.setGeometry(new ol.geom.Point(o))})}}},generatePointsCircle:function(t,e){var o=2*Math.PI,n=o/12,i=25*(2+t)/o,a=o/t,r=[],l=void 0,s=void 0;for(l=t-1;0<=l;l--)s=n+l*a,r[l]=[e[0]+i*Math.cos(s),e[1]+i*Math.sin(s)];return r},updateMap:function(t){var e=this,o=e.vectorLayer,n=e.initVectorSource(t);e.initCluster(),e.initVectorLayer();var i=e.map.getLayers();null!=i.remove(o)&&i.push(e.vectorLayer),e.fitMap(),n?e.fitMap():e.toDefaultMap()}};null!=document.getElementById("map-main")&&(u(window).on("load",function(){null!=window._townhub_add_ons_map&&window._townhub_add_ons_map.length?o.init("map-main",window._townhub_add_ons_map):o.init("map-main",e())}),window.addEventListener("listingsChanged",function(t){"ajax_search"==t.detail&&o.updateMap(e())})),u(".singleMap").length&&u(window).on("load",function(){u(".singleMap").each(function(){var t=u(this),e=t.attr("id"),o=[parseFloat(t.data("lng")),parseFloat(t.data("lat"))],n=t.data("loc"),i=t.data("zoom")?parseInt(t.data("zoom")):parseInt(_townhub_add_ons.map_zoom),a=new ol.View({center:ol.proj.fromLonLat(o),zoom:i}),r=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(o,"EPSG:4326","EPSG:3857")),name:n}),l=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",src:_townhub_add_ons.marker,crossOrigin:"anonymous"})});r.setStyle(l);var s=new ol.layer.Vector({source:new ol.source.Vector({features:[r]})});new ol.Map({target:e,view:a,layers:[new ol.layer.Tile({preload:3,source:new ol.source.OSM}),s],loadTilesWhileAnimating:!0,interactions:ol.interaction.defaults({mouseWheelZoom:!1})})})})}(jQuery);